# NodeJS with MySQL Deployment on Kubernetes

## Instructions

1. Clone the public repository with the following command:
```bash
git clone https://github.com/Markeur123/nodejs-mysql-k8s.git
```

2. Run the bash script found in the local repository with the following command to deploy :
```bash
. deploy.sh
```
   The steps involved in the execution of the bash script will be outlined in the next section.

3. Open a web browser and type `http://<host_IP>:30000`, where `<host_IP>` is the host machine IP address, in the address bar to access the webpage that shows a "Hello World" string which is generated by the NodeJS application hosted in the Dev environment.

   Likewise, type `http://<host_IP>:30001` in the address bar to access the webpage that shows the same string which is generated by the same application hosted in the Prod environment.

## Steps in the Bash Script `deploy.sh`

The bash script in the bash script does the following:

1. Navigate to `dev` directory.
```bash
cd dev
```

2. Create a new project in the `dev` directory with `index-dev.js` file in it.
```bash
npm init -y
```

3. Install packages that the `index-dev.js` has dependencies on.
```bash
npm install mysql http
```

4. Build a Docker image from a Dockerfile.
```bash
docker build -t nodejsapp-dev .
```

5. Tag the Docker image built in the previous step for sharing it in the Docker Hub registry.
```bash
docker tag nodejsapp-dev:latest markeur/nodejs-dev:latest
```

6. Log in to the Docker Hub registry.
```bash
docker login
```

7. Share the image built in step (4) in the Docker Hub registry.
```bash
docker push markeur/nodejs-dev:latest
```

8. Navigate to `prod` directory.
```bash
cd ../prod
```

9. Repeat step (2) and step (3) in the `prod` directory with `index-prod.js` file in it.
```bash
npm init -y
npm install mysql http
```

10. Build a Docker image from a Dockerfile.
```bash
docker build -t nodejsapp-prod .
```

11. Tag the Docker image built in the previous step for sharing it in the Docker Hub registry.
```bash
docker tag nodejsapp-prod:latest markeur/nodejs-prod:latest
```

12. Share the image built in step (10) in the Docker Hub registry.
```bash
docker push markeur/nodejs-prod:latest
```

13. Navigate to root directory.
```bash
cd ..
```

14. Start a cluster.
```bash
minikube start
```

15. Create both `dev` and `prod` environment in the cluster.
```bash
kubectl create namespace dev
kubectl create namespace prod
```

16. Add a chart repository named `stable`. This is for deploying mysql database for both `dev` and `prod` environment.
```bash
helm repo add stable https://charts.helm.sh/stable
```

17. Deploy MySQL database for both `dev` and `prod` environment into the cluster by installing the following helm charts.
```bash
helm install mysql-dev -n dev --set mysqlUser=dbdevuser,mysqlPassword=password,mysqlDatabase=dbdev stable/mysql
helm install mysql-prod -n prod --set mysqlUser=dbproduser,mysqlPassword=password,mysqlDatabase=dbprod stable/mysql
```

18. Deploy NodeJS application for both `dev` and `prod` environment into the cluster by installing the following helm charts.
```bash
helm install nodejs-dev ./nodejs -n dev --values ./nodejs/nodejs-dev-values.yaml
helm install nodejs-prod ./nodejs -n prod --values ./nodejs/nodejs-prod-values.yaml
```

19. Do port forwarding of service for NodeJS application hosted in both `dev` and `prod` environment so that the host machine can access the webpage.
```bash
ssh -i ~/.minikube/machines/minikube/id_rsa docker@$(minikube ip) -fNT -L \*:30000:0.0.0.0:30000
ssh -i ~/.minikube/machines/minikube/id_rsa docker@$(minikube ip) -fNT -L \*:30001:0.0.0.0:30001
```
